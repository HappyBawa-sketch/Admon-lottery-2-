import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, onAuthStateChanged, signInAnonymously } from 'firebase/auth';
import { getFirestore, doc, onSnapshot, setDoc, updateDoc, collection, getDocs, getDoc } from 'firebase/firestore';

/**
 * The main application component. It serves as the root of the component tree,
 * handling global state, Firebase initialization, and routing between different views.
 */
const App = () => {
    // --- STATE MANAGEMENT ---
    // Manages the active tab for the UI, driving conditional rendering.
    const [activeTab, setActiveTab] = useState('lottery-tab');
    // Stores the latest draw results for the live view.
    const [drawResults, setDrawResults] = useState(null);
    // Stores the countdown timer string.
    const [countdown, setCountdown] = useState('');
    // Stores the current date and time string.
    const [currentTime, setCurrentTime] = useState('');
    // Manages the authentication state for the admin panel.
    const [isAuthenticated, setIsAuthenticated] = useState(false);
    // Stores the full history data fetched from Firestore.
    const [historyData, setHistoryData] = useState({});
    // Manages the loading state for data fetches.
    const [isLoading, setIsLoading] = useState(true);
    // Stores any critical application errors.
    const [error, setError] = useState(null);
    // Tracks if Firebase authentication has completed its initial check.
    const [isAuthReady, setIsAuthReady] = useState(false);

    // --- CONFIG & CONSTANTS ---
    const ADMIN_PASSWORD = "lottoditto";
    const LOTTERY_RESULTS_COLLECTION = 'lottery-draws';
    const DRAW_INTERVAL_MINUTES = 15;
    const DRAW_START_HOUR = 9; // 9 AM
    const DRAW_END_HOUR = 21;  // 9 PM
    
    // --- FIREBASE INITIALIZATION AND AUTHENTICATION LOGIC ---
    // This effect runs only once on component mount to set up Firebase.
    useEffect(() => {
        try {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            
            if (!firebaseConfig) {
                setError("Configuration Error: Firebase configuration is missing.");
                setIsLoading(false);
                return;
            }
            
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            // onAuthStateChanged is the most reliable way to know when auth is complete.
            const unsubscribeAuth = onAuthStateChanged(auth, async (user) => {
                if (user) {
                    console.log("Firebase signed in successfully.");
                    setIsAuthReady(true);
                    // Begin listening for live draw data after successful authentication.
                    listenForLiveDraws(db);
                } else {
                    console.error("Authentication failed. App will be non-functional.");
                    setError("Authentication Failed: The application could not connect to the database.");
                    setIsAuthReady(true);
                    setIsLoading(false);
                }
            });

            // Attempt to sign in. The onAuthStateChanged listener will handle the result.
            const signIn = async () => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (e) {
                    console.error("Initial sign-in failed:", e);
                    await signInAnonymously(auth);
                }
            };
            signIn();

            return () => unsubscribeAuth();
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            setError(`Initialization Error: ${e.message}`);
            setIsLoading(false);
        }
    }, []);

    // --- LIVE DRAW AND COUNTDOWN LOGIC ---
    // This effect handles the live timer and countdown display.
    useEffect(() => {
        const intervalId = setInterval(() => {
            const now = new Date();
            updateCountdown(now);
            updateDateTime(now);
        }, 1000);
        return () => clearInterval(intervalId);
    }, []);

    const updateDateTime = (now) => {
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
        setCurrentTime(now.toLocaleDateString('en-US', options));
    };

    const updateCountdown = (now) => {
        const currentHours = now.getHours();
        if (currentHours < DRAW_START_HOUR) {
            setCountdown(`Draws begin at ${DRAW_START_HOUR}:00 AM.`);
            return;
        } else if (currentHours >= DRAW_END_HOUR) {
            setCountdown(`Draws for today have ended.`);
            return;
        }

        const currentMinutes = now.getMinutes();
        const nextDrawMinute = Math.ceil((currentMinutes + 1) / DRAW_INTERVAL_MINUTES) * DRAW_INTERVAL_MINUTES;
        const nextDrawTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), now.getHours(), nextDrawMinute, 0);

        if (nextDrawTime.getHours() > DRAW_END_HOUR) {
            setCountdown(`Draws for today have ended.`);
            return;
        }

        const timeDiff = nextDrawTime.getTime() - now.getTime();
        const minutes = Math.floor(timeDiff / (1000 * 60));
        const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
        setCountdown(`Next draw in: ${minutes}m ${seconds}s`);
    };

    /**
     * Sets up a real-time listener for today's lottery results.
     * @param {object} db - The Firestore database instance.
     */
    const listenForLiveDraws = (db) => {
        if (!isAuthReady) return; // Guard clause to prevent listening before auth is ready.
        
        const today = new Date().toISOString().slice(0, 10);
        const todayDocRef = doc(db, LOTTERY_RESULTS_COLLECTION, today);
        
        const unsubscribe = onSnapshot(todayDocRef, (docSnap) => {
            setIsLoading(false);
            if (docSnap.exists() && docSnap.data().draws) {
                const draws = docSnap.data().draws;
                if (Object.keys(draws).length > 0) {
                    const lastDrawTime = Object.keys(draws).sort().pop();
                    setDrawResults({ time: lastDrawTime, numbers: draws[lastDrawTime] });
                } else {
                    setDrawResults(null);
                }
            } else {
                setDrawResults(null);
            }
        }, (err) => {
            console.error("Error fetching live draw data:", err);
            setError("Data Fetch Error: Failed to load live draw data. Please check your network and Firebase rules.");
            setIsLoading(false);
        });

        // The return function acts as a cleanup mechanism for the listener.
        return unsubscribe;
    };

    return (
        <div className="bg-gray-100 min-h-screen p-4 sm:p-8 flex justify-center items-start font-inter text-gray-800">
            <div className="w-full max-w-4xl bg-white rounded-2xl shadow-2xl overflow-hidden">
                <div className="bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-6 sm:p-10 text-center">
                    <h1 className="text-4xl sm:text-5xl font-extrabold tracking-wide">ADMON LOTTERY</h1>
                </div>
                
                <div className="flex bg-white border-b border-gray-200">
                    <TabButton name="Live Draw" tabId="lottery-tab" activeTab={activeTab} setActiveTab={setActiveTab} />
                    <TabButton name="History" tabId="history-tab" activeTab={activeTab} setActiveTab={setActiveTab} />
                    <TabButton name="Admin" tabId="admin-tab" activeTab={activeTab} setActiveTab={setActiveTab} />
                </div>

                {/* Conditional rendering based on active tab and loading/error states */}
                {error ? (
                    <ErrorDisplay message={error} />
                ) : (
                    <>
                        {activeTab === 'lottery-tab' && <LiveDraw isLoading={isLoading} results={drawResults} countdown={countdown} currentTime={currentTime} />}
                        {activeTab === 'history-tab' && <History isAuthReady={isAuthReady} />}
                        {activeTab === 'admin-tab' && <AdminPanel isAuthenticated={isAuthenticated} setIsAuthenticated={setIsAuthenticated} password={ADMIN_PASSWORD} isAuthReady={isAuthReady} />}
                    </>
                )}
            </div>
        </div>
    );
};

// --- SUB-COMPONENTS ---

/** A reusable button component for tab navigation. */
const TabButton = ({ name, tabId, activeTab, setActiveTab }) => (
    <button
        onClick={() => setActiveTab(tabId)}
        className={`flex-1 p-4 text-center font-semibold text-lg transition-colors duration-200 ${
            activeTab === tabId ? 'bg-indigo-50 text-indigo-700 border-b-4 border-indigo-500' : 'text-gray-600 hover:bg-gray-50'
        }`}
    >
        {name}
    </button>
);

/** Displays a clear, formatted error message to the user. */
const ErrorDisplay = ({ message }) => (
    <div className="p-8">
        <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl relative text-center" role="alert">
            <strong className="font-bold">Application Error!</strong>
            <p className="block sm:inline mt-2">{message}</p>
        </div>
    </div>
);

/**
 * Component for the Live Draw tab. It renders the current results,
 * countdown, and time based on its props.
 */
const LiveDraw = ({ isLoading, results, countdown, currentTime }) => {
    return (
        <div className="p-8">
            <div className="text-right text-gray-500 text-sm mb-4">{currentTime}</div>
            <div className="text-center min-h-[200px] flex flex-col items-center justify-center">
                {isLoading ? (
                    <div className="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4 animate-spin"></div>
                ) : results ? (
                    <>
                        <p className="text-gray-500 text-sm mb-2">Last draw at {results.time}</p>
                        <div className="flex justify-center items-center space-x-6">
                            {results.numbers.map((num, index) => (
                                <div key={index} className="bg-blue-600 text-white font-bold text-3xl w-24 h-24 rounded-full flex items-center justify-center shadow-xl">
                                    {num}
                                </div>
                            ))}
                        </div>
                    </>
                ) : (
                    <p className="text-gray-400 text-lg">No draws yet today. Stay tuned!</p>
                )}
            </div>
            <div className="text-center mt-8">
                <p className="text-2xl font-bold text-gray-600">{countdown}</p>
            </div>
        </div>
    );
};

/**
 * Component for the History tab. Fetches and displays past draw data.
 */
const History = ({ isAuthReady }) => {
    const [historyData, setHistoryData] = useState({});
    const [filteredHistory, setFilteredHistory] = useState([]);
    const [years, setYears] = useState([]);
    const [selectedYear, setSelectedYear] = useState('');
    const [selectedDate, setSelectedDate] = useState('');
    const [isLoading, setIsLoading] = useState(false);

    // Effect to fetch history data when the component is first mounted.
    useEffect(() => {
        if (isAuthReady) {
            loadHistory();
        }
    }, [isAuthReady]);

    // Effect to filter history whenever the data or filters change.
    useEffect(() => {
        let dates = Object.keys(historyData).sort().reverse();
        if (selectedYear) {
            dates = dates.filter(date => date.startsWith(selectedYear));
        }
        if (selectedDate) {
            dates = dates.filter(date => date === selectedDate);
        }
        setFilteredHistory(dates);
    }, [historyData, selectedYear, selectedDate]);

    const loadHistory = async () => {
        if (!isAuthReady) return; // Prevent execution before auth is ready.
        setIsLoading(true);
        const db = getFirestore();
        const historyCollectionRef = collection(db, 'lottery-draws');
        try {
            const querySnapshot = await getDocs(historyCollectionRef);
            const fetchedData = {};
            const yearSet = new Set();
            querySnapshot.forEach(doc => {
                const data = doc.data();
                if (data && data.draws) {
                    fetchedData[doc.id] = data.draws;
                    yearSet.add(doc.id.substring(0, 4));
                }
            });
            setHistoryData(fetchedData);
            setYears(Array.from(yearSet).sort().reverse());
        } catch (err) {
            console.error("Error loading history:", err);
            // Can add a more specific error state here if needed.
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="p-8">
            <h2 className="text-3xl font-bold text-center mb-6 text-gray-800">Lottery History</h2>
            <div className="flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-4 mb-6">
                <select value={selectedYear} onChange={e => {setSelectedYear(e.target.value); setSelectedDate('');}} className="w-full md:w-auto p-2 border rounded-lg">
                    <option value="">All Years</option>
                    {years.map(year => <option key={year} value={year}>{year}</option>)}
                </select>
                <input type="date" value={selectedDate} onChange={e => setSelectedDate(e.target.value)} className="w-full md:w-auto p-2 border rounded-lg" />
                <button onClick={loadHistory} className="w-full md:w-auto bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition-colors">Refresh History</button>
            </div>
            <div className="bg-white shadow-lg rounded-lg overflow-hidden">
                <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50">
                        <tr>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Time</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Draw</th>
                        </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                        {isLoading ? (
                            <tr><td colSpan="3" className="p-6 text-center text-gray-400">Loading history...</td></tr>
                        ) : (
                            filteredHistory.length > 0 ? (
                                filteredHistory.map(date => 
                                    Object.keys(historyData[date]).sort().map(time => (
                                        <tr key={`${date}-${time}`}>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{date}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{time}</td>
                                            <td className="px-6 py-4">
                                                <div className="flex space-x-2">
                                                    {historyData[date][time].map((num, idx) => (
                                                        <span key={idx} className="w-8 h-8 flex items-center justify-center rounded-full bg-blue-500 text-white text-xs font-bold">{num}</span>
                                                    ))}
                                                </div>
                                            </td>
                                        </tr>
                                    ))
                                )
                            ) : (
                                <tr><td colSpan="3" className="p-6 text-center text-gray-400">No history found for this selection.</td></tr>
                            )
                        )}
                    </tbody>
                </table>
            </div>
        </div>
    );
};

/**
 * Component for the Admin Panel. Manages its own login and data submission state.
 */
const AdminPanel = ({ isAuthenticated, setIsAuthenticated, password, isAuthReady }) => {
    const [loginStatus, setLoginStatus] = useState('');
    const [adminPassword, setAdminPassword] = useState('');
    const [drawDate, setDrawDate] = useState('');
    const [drawTime, setDrawTime] = useState('');
    const [resultA, setResultA] = useState('');
    const [resultB, setResultB] = useState('');
    const [resultC, setResultC] = useState('');
    const [saveStatus, setSaveStatus] = useState('');
    
    // Set default date/time on mount or when switching to authenticated view.
    useEffect(() => {
        if (isAuthenticated) {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            setDrawDate(`${year}-${month}-${day}`);
            setDrawTime(`${hours}:${minutes}`);
        }
    }, [isAuthenticated]);

    const handleAdminLogin = () => {
        if (adminPassword === password) {
            setIsAuthenticated(true);
            setLoginStatus('');
        } else {
            setLoginStatus('Incorrect password.');
        }
    };

    const handleGenerateRandom = () => {
        const randomNumbers = Array.from({length: 3}, () => Math.floor(Math.random() * 100).toString().padStart(2, '0'));
        setResultA(randomNumbers[0]);
        setResultB(randomNumbers[1]);
        setResultC(randomNumbers[2]);
    };

    const handleSaveDraw = async () => {
        if (!isAuthReady) {
            setSaveStatus("Error: Not authenticated. Please reload the page.");
            return;
        }

        if (!drawDate || !drawTime || !resultA || !resultB || !resultC) {
            setSaveStatus('Please fill in all fields.');
            return;
        }

        const db = getFirestore();
        const docRef = doc(db, 'lottery-draws', drawDate);
        const drawData = { [drawTime]: [resultA, resultB, resultC] };

        try {
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                await updateDoc(docRef, { draws: { ...docSnap.data().draws, ...drawData } });
            } else {
                await setDoc(docRef, { draws: drawData });
            }
            setSaveStatus('Draw saved successfully!');
            setTimeout(() => setSaveStatus(''), 3000);
        } catch (e) {
            console.error("Error saving draw:", e);
            setSaveStatus('Error saving draw.');
        }
    };

    const handleExportCsv = async () => {
        if (!isAuthReady) {
            setSaveStatus("Error: Not authenticated. Please reload the page.");
            return;
        }
        setSaveStatus('Exporting...');
        const db = getFirestore();
        const historyCollectionRef = collection(db, 'lottery-draws');
        try {
            const querySnapshot = await getDocs(historyCollectionRef);
            let csvContent = "data:text/csv;charset=utf-8,Date,Time,Result 1,Result 2,Result 3\n";
            querySnapshot.forEach((doc) => {
                const date = doc.id;
                const data = doc.data();
                if (data && data.draws) {
                    Object.keys(data.draws).sort().forEach(time => {
                        const numbers = data.draws[time];
                        csvContent += `${date},${time},${numbers[0]},${numbers[1]},${numbers[2]}\n`;
                    });
                }
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "lottery-history.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            setSaveStatus('Export successful!');
            setTimeout(() => setSaveStatus(''), 3000);
        } catch (e) {
            console.error("Error exporting data:", e);
            setSaveStatus('Export failed.');
        }
    };

    return (
        <div className="p-8">
            <h2 className="text-3xl font-bold text-center mb-6 text-gray-800">Admin Panel</h2>
            {!isAuthenticated ? (
                <div className="space-y-4 max-w-sm mx-auto">
                    <input type="password" value={adminPassword} onChange={e => setAdminPassword(e.target.value)} placeholder="Enter Password" className="w-full p-3 border rounded-lg" />
                    <button onClick={handleAdminLogin} className="w-full bg-blue-600 text-white font-bold p-3 rounded-lg hover:bg-blue-700 transition-colors">Login</button>
                    {loginStatus && <p className="mt-2 text-center text-red-500">{loginStatus}</p>}
                </div>
            ) : (
                <div className="space-y-6">
                    <div className="flex space-x-4">
                        <input type="date" value={drawDate} onChange={e => setDrawDate(e.target.value)} className="w-1/2 p-3 border rounded-lg" />
                        <input type="time" value={drawTime} onChange={e => setDrawTime(e.target.value)} className="w-1/2 p-3 border rounded-lg" />
                    </div>
                    <div className="flex space-x-2">
                        <input type="number" value={resultA} onChange={e => setResultA(e.target.value)} placeholder="Result 1" className="w-1/3 p-3 text-center border rounded-lg" />
                        <input type="number" value={resultB} onChange={e => setResultB(e.target.value)} placeholder="Result 2" className="w-1/3 p-3 text-center border rounded-lg" />
                        <input type="number" value={resultC} onChange={e => setResultC(e.target.value)} placeholder="Result 3" className="w-1/3 p-3 text-center border rounded-lg" />
                    </div>
                    <div className="flex flex-col space-y-4">
                        <button onClick={handleSaveDraw} className="bg-blue-600 text-white font-bold p-3 rounded-lg hover:bg-blue-700 transition-colors">Save Draw</button>
                        <button onClick={handleGenerateRandom} className="bg-yellow-500 text-white font-bold p-3 rounded-lg hover:bg-yellow-600 transition-colors">Generate Random</button>
                        {saveStatus && <p className={`text-center text-sm ${saveStatus.includes('Error') ? 'text-red-500' : 'text-green-500'}`}>{saveStatus}</p>}
                    </div>
                    <p onClick={handleExportCsv} className="text-center text-sm text-gray-500 cursor-pointer hover:underline mt-4">Export all history to CSV</p>
                    <p onClick={() => setIsAuthenticated(false)} className="text-center text-sm text-red-500 cursor-pointer hover:underline">Logout</p>
                </div>
            )}
        </div>
    );
};

export default App;
