<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admon Lottery</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #e2e8f0;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 600px;
            background: #fff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            overflow: hidden;
            margin: 20px;
        }

        .tab-content {
            display: none;
            padding: 24px;
        }

        .tab-content.active {
            display: block;
        }
        
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            padding: 24px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
    </style>
</head>
<body class="bg-gray-200">

    <div class="container">
        <!-- Main Tabs -->
        <div class="flex border-b border-gray-200">
            <button id="lottery-tab" class="nav-tab flex-1 py-4 text-center text-sm md:text-base font-bold text-gray-700 bg-white border-b-2 border-transparent hover:bg-gray-100 transition-colors duration-200" data-tab="lottery-tab-content">Lottery</button>
            <button id="history-tab" class="nav-tab flex-1 py-4 text-center text-sm md:text-base font-bold text-gray-700 bg-white border-b-2 border-transparent hover:bg-gray-100 transition-colors duration-200" data-tab="history-tab-content">History</button>
            <button id="admin-tab" class="nav-tab flex-1 py-4 text-center text-sm md:text-base font-bold text-gray-700 bg-white border-b-2 border-transparent hover:bg-gray-100 transition-colors duration-200" data-tab="admin-tab-content">Admin Panel</button>
        </div>

        <!-- Lottery Tab Content -->
        <div id="lottery-tab-content" class="tab-content">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Today's Lottery Results</h2>
            <div id="today-results-body" class="mb-6">
                <p id="loading-message" class="text-center text-gray-500 text-sm">Loading today's draws...</p>
                <div id="results-display" class="hidden">
                    <!-- Results will be dynamically inserted here -->
                </div>
            </div>

            <div class="text-center mt-8">
                <span id="countdown" class="text-gray-600 text-lg md:text-2xl font-semibold"></span>
            </div>
        </div>

        <!-- History Tab Content -->
        <div id="history-tab-content" class="tab-content">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Lottery History</h2>
            <div class="flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-4 mb-6">
                <select id="year-filter" class="px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow">
                    <!-- Year options will be dynamically inserted here -->
                </select>
                <input type="date" id="date-filter" class="px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow">
            </div>

            <div id="history-results" class="table-container">
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead class="bg-gray-100 border-b border-gray-200">
                        <tr>
                            <th class="px-4 py-2 text-left text-sm font-semibold text-gray-600">Time</th>
                            <th class="px-4 py-2 text-left text-sm font-semibold text-gray-600">Draw</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body" class="divide-y divide-gray-200">
                        <tr>
                            <td colspan="2" class="p-4 text-center text-gray-500">Select a year or date to view history.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Admin Panel Tab Content -->
        <div id="admin-tab-content" class="tab-content">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Admin Panel</h2>
            <div id="login-form">
                <p class="text-center text-sm text-gray-600 mb-4">Please enter the admin password to continue.</p>
                <input type="password" id="admin-password" placeholder="Enter Password" class="w-full px-4 py-2 mb-4 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow">
                <button id="login-btn" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors duration-200">Login</button>
                <div id="login-status" class="mt-4 text-center text-red-500"></div>
            </div>

            <div id="admin-panel" class="hidden">
                <p class="text-sm text-gray-600 mb-4">Enter the new lottery results below.</p>
                <div class="flex flex-col space-y-4 mb-4">
                    <input type="date" id="draw-date" class="px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow">
                    <input type="time" id="draw-time" class="px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow">
                </div>
                <div class="flex space-x-2 md:space-x-4 mb-4">
                    <input type="number" id="result-a-input" placeholder="Result 1" class="w-1/3 px-2 py-2 text-center rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow">
                    <input type="number" id="result-b-input" placeholder="Result 2" class="w-1/3 px-2 py-2 text-center rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow">
                    <input type="number" id="result-c-input" placeholder="Result 3" class="w-1/3 px-2 py-2 text-center rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow">
                </div>
                <button id="start-draw-btn" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors duration-200">Save Draw</button>
                <button id="random-results-btn" class="w-full bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg mt-2 hover:bg-yellow-600 transition-colors duration-200">Generate Random</button>
                <p id="save-status" class="text-center text-sm mt-2"></p>
                <p id="export-btn" class="mt-4 text-blue-500 text-sm font-semibold cursor-pointer text-center hover:underline">Export all history to CSV</p>
                <p id="logout-btn" class="mt-4 text-red-500 text-sm font-semibold cursor-pointer text-center hover:underline">Logout</p>
            </div>
        </div>
    </div>

    <!-- Message box container -->
    <div id="message-box" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 id="message-title" class="text-lg font-bold mb-2"></h3>
            <p id="message-text" class="text-gray-700 mb-4"></p>
            <div class="flex justify-end space-x-2">
                <button id="message-cancel" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">Cancel</button>
                <button id="message-confirm" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">OK</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, onSnapshot, setDoc, updateDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ADMIN PASSWORD (CHANGE THIS) ---
        const ADMIN_PASSWORD = "lottoditto";

        // --- YOUR FIREBASE CONFIGURATION HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyC...",
            authDomain: "admon-punjab-lottery.firebaseapp.com",
            projectId: "admon-punjab-lottery",
            storageBucket: "admon-punjab-lottery.appspot.com",
            messagingSenderId: "1053580219610",
            appId: "1:1053580219610:web:8ae6568245d635382c081e3"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Constants
        const LOTTERY_RESULTS_COLLECTION = 'lottery-draws';
        const DRAW_INTERVAL_MINUTES = 15;

        let countdownInterval;
        let allHistoryData = {};
        let isAuthenticated = false;

        // HTML Elements
        const elements = {
            tabs: document.querySelectorAll('.nav-tab'),
            lotteryTab: document.getElementById('lottery-tab'),
            historyTab: document.getElementById('history-tab'),
            adminTab: document.getElementById('admin-tab'),
            countdown: document.getElementById('countdown'),
            currentDatetime: document.getElementById('current-datetime'),
            resultsDisplay: document.getElementById('results-display'),
            loadingMessage: document.getElementById('loading-message'),
            resultA: document.getElementById('result-a'),
            resultB: document.getElementById('result-b'),
            resultC: document.getElementById('result-c'),
            todayResultsBody: document.getElementById('today-results-body'),
            drawDateInput: document.getElementById('draw-date'),
            drawTimeInput: document.getElementById('draw-time'),
            resultAInput: document.getElementById('result-a-input'),
            resultBInput: document.getElementById('result-b-input'),
            resultCInput: document.getElementById('result-c-input'),
            saveResultsBtn: document.getElementById('save-results-btn'),
            startDrawBtn: document.getElementById('start-draw-btn'),
            randomResultsBtn: document.getElementById('random-results-btn'),
            historyTableBody: document.getElementById('history-table-body'),
            adminPasswordInput: document.getElementById('admin-password'),
            loginBtn: document.getElementById('login-btn'),
            loginForm: document.getElementById('login-form'),
            adminPanel: document.getElementById('admin-panel'),
            loginStatus: document.getElementById('login-status'),
            exportBtn: document.getElementById('export-btn'),
            yearFilter: document.getElementById('year-filter'),
            dateFilter: document.getElementById('date-filter'),
            messageBox: document.getElementById('message-box'),
            messageTitle: document.getElementById('message-title'),
            messageText: document.getElementById('message-text'),
            messageConfirm: document.getElementById('message-confirm'),
            messageCancel: document.getElementById('message-cancel'),
            saveStatus: document.getElementById('save-status')
        };
        
        // Tab switching logic
        function switchTab(tabId) {
            elements.tabs.forEach(tab => {
                tab.classList.remove('border-blue-500', 'bg-blue-50', 'text-blue-600');
                tab.classList.add('border-transparent', 'bg-white', 'text-gray-700');
            });
            document.getElementById(tabId).classList.add('border-blue-500', 'bg-blue-50', 'text-blue-600');
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(document.getElementById(tabId).dataset.tab).classList.add('active');
            
            // Special actions for each tab
            if (tabId === 'history-tab') {
                loadHistoryData();
            }
        }
        
        elements.tabs.forEach(tab => {
            tab.addEventListener('click', () => switchTab(tab.id));
        });
        
        // Set initial active tab
        switchTab('lottery-tab');

        // Function to show custom message box
        function showMessageBox(title, message, showCancel = false) {
            elements.messageTitle.textContent = title;
            elements.messageText.textContent = message;
            elements.messageCancel.classList.toggle('hidden', !showCancel);
            elements.messageBox.classList.remove('hidden');
            return new Promise(resolve => {
                const onConfirm = () => {
                    elements.messageBox.classList.add('hidden');
                    elements.messageConfirm.removeEventListener('click', onConfirm);
                    elements.messageCancel.removeEventListener('click', onCancel);
                    resolve(true);
                };
                const onCancel = () => {
                    elements.messageBox.classList.add('hidden');
                    elements.messageConfirm.removeEventListener('click', onConfirm);
                    elements.messageCancel.removeEventListener('click', onCancel);
                    resolve(false);
                };
                elements.messageConfirm.addEventListener('click', onConfirm);
                elements.messageCancel.addEventListener('click', onCancel);
            });
        }

        // Countdown Timer
        function updateCountdown() {
            const now = new Date();
            const currentMinutes = now.getMinutes();
            const currentSeconds = now.getSeconds();
            const nextDrawMinute = Math.ceil((currentMinutes + 1) / DRAW_INTERVAL_MINUTES) * DRAW_INTERVAL_MINUTES;
            const nextDrawTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), now.getHours(), nextDrawMinute, 0);

            const timeDiff = nextDrawTime.getTime() - now.getTime();
            if (timeDiff <= 0) {
                elements.countdown.textContent = `A new draw is happening now.`;
                return;
            }

            const minutes = Math.floor(timeDiff / (1000 * 60));
            const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
            elements.countdown.textContent = `Next draw in: ${minutes}m ${seconds}s`;
        }

        // Firebase Listeners
        function startFirestoreListeners() {
            const today = new Date().toISOString().slice(0, 10);
            const todayDocRef = doc(db, LOTTERY_RESULTS_COLLECTION, today);

            // Listen for today's results
            onSnapshot(todayDocRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    const draws = data.draws;
                    if (draws && Object.keys(draws).length > 0) {
                        const lastDrawTime = Object.keys(draws).sort().pop();
                        const lastDrawNumbers = draws[lastDrawTime];
                        displayTodayResults(lastDrawTime, lastDrawNumbers);
                    } else {
                        elements.todayResultsBody.innerHTML = `<p class="text-center text-gray-500 text-sm">No draws yet today.</p>`;
                    }
                } else {
                    elements.todayResultsBody.innerHTML = `<p class="text-center text-gray-500 text-sm">No draws yet today.</p>`;
                }
            }, (error) => {
                console.error("Error fetching today's document:", error);
                elements.todayResultsBody.innerHTML = `<p class="text-center text-red-500 text-sm">Error connecting to database. Please refresh.</p>`;
            });

            // Start countdown timer
            clearInterval(countdownInterval);
            updateCountdown();
            countdownInterval = setInterval(updateCountdown, 1000);
        }

        function displayTodayResults(time, numbers) {
            let html = `
                <div class="bg-gray-100 p-4 rounded-lg">
                    <p class="text-lg font-bold mb-2">Last Draw (${time})</p>
                    <div class="flex justify-center space-x-4">
                        ${numbers.map(num => `<span class="text-xl md:text-3xl font-bold bg-blue-500 text-white w-10 h-10 md:w-16 md:h-16 flex items-center justify-center rounded-full shadow-lg">${num}</span>`).join('')}
                    </div>
                </div>
            `;
            elements.todayResultsBody.innerHTML = html;
        }

        // Admin Panel Functions
        elements.loginBtn.addEventListener('click', () => {
            if (elements.adminPasswordInput.value === ADMIN_PASSWORD) {
                isAuthenticated = true;
                elements.loginForm.classList.add('hidden');
                elements.adminPanel.classList.remove('hidden');
                elements.loginStatus.textContent = '';
                setupAdminPanel();
            } else {
                elements.loginStatus.textContent = 'Incorrect password.';
            }
        });

        elements.randomResultsBtn.addEventListener('click', () => {
            const randomNumbers = Array.from({length: 3}, () => Math.floor(Math.random() * 100).toString().padStart(2, '0'));
            elements.resultAInput.value = randomNumbers[0];
            elements.resultBInput.value = randomNumbers[1];
            elements.resultCInput.value = randomNumbers[2];
        });

        elements.startDrawBtn.addEventListener('click', async () => {
            if (!isAuthenticated) return;

            const date = elements.drawDateInput.value;
            const time = elements.drawTimeInput.value;
            const resultA = elements.resultAInput.value;
            const resultB = elements.resultBInput.value;
            const resultC = elements.resultCInput.value;

            if (!date || !time || !resultA || !resultB || !resultC) {
                showMessageBox('Error', 'Please fill in all fields.');
                return;
            }

            const confirm = await showMessageBox('Confirm Save', `Are you sure you want to save the draw for ${date} at ${time}?`, true);
            if (!confirm) return;

            const docRef = doc(db, LOTTERY_RESULTS_COLLECTION, date);
            
            try {
                const docSnap = await getDoc(docRef);
                const drawData = {
                    [time]: [resultA, resultB, resultC]
                };

                if (docSnap.exists()) {
                    await updateDoc(docRef, { draws: { ...docSnap.data().draws, ...drawData } });
                } else {
 
